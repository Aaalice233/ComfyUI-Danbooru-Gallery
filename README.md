# ComfyUI Danbooru Gallery
<img width="966" height="830" alt="image" src="https://github.com/user-attachments/assets/e2a5d34e-0001-417e-bf8e-7753521ea0d3" />

[ä¸­æ–‡](#ä¸­æ–‡ç‰ˆæœ¬) | [English](#english-version)

---

## ä¸­æ–‡ç‰ˆæœ¬

### ç®€ä»‹

ä¸€ä¸ªåŸºäº Danbooru API çš„ ComfyUI å›¾åƒæœç´¢å’Œç”»å»Šæ’ä»¶ï¼Œæ”¯æŒé€šè¿‡æ ‡ç­¾æœç´¢å›¾åƒã€æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€å†…å®¹è¿‡æ»¤ç­‰åŠŸèƒ½ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸ” **æ ‡ç­¾æœç´¢**: æ”¯æŒé€šè¿‡ Danbooru æ ‡ç­¾è¿›è¡Œç²¾ç¡®æœç´¢
- ğŸ“„ **åˆ†é¡µåŠ è½½**: é«˜æ•ˆçš„åˆ†é¡µæœºåˆ¶ï¼Œæå‡æµè§ˆä½“éªŒ
- ğŸ’¡ **æ™ºèƒ½è¡¥å…¨**: è¾“å…¥æ—¶è‡ªåŠ¨è¡¥å…¨çƒ­é—¨æ ‡ç­¾
- ğŸ¨ **å›¾åƒé¢„è§ˆ**: é«˜è´¨é‡å›¾åƒé¢„è§ˆå’Œä¸‹è½½
- ğŸ”§ **è®¾ç½®ç®¡ç†**: å¤šè¯­è¨€ã€é»‘åå•ã€æç¤ºè¯è¿‡æ»¤è®¾ç½®
- ğŸ¯ **ComfyUI é›†æˆ**: å®Œç¾é›†æˆåˆ° ComfyUI å·¥ä½œæµ
- ğŸŒŠ **ç€‘å¸ƒæµå¸ƒå±€**: å“åº”å¼ç€‘å¸ƒæµå›¾åƒæ’åˆ—
- ğŸ“Š **åˆ†çº§è¿‡æ»¤**: æ”¯æŒæŒ‰å›¾åƒåˆ†çº§è¿‡æ»¤å†…å®¹
- ğŸ·ï¸ **ç±»åˆ«é€‰æ‹©**: å¯é€‰æ‹©è¾“å‡ºçš„æ ‡ç­¾ç±»åˆ«
- ğŸ“ **æ ¼å¼åŒ–é€‰é¡¹**: æ”¯æŒæ‹¬å·è½¬ä¹‰å’Œä¸‹åˆ’çº¿æ›¿æ¢
- ğŸ–ï¸ **æ’è¡Œæ¦œæ¨¡å¼**: æ”¯æŒæŒ‰çƒ­åº¦æ’åºæ˜¾ç¤º
- ğŸš« **é»‘åå•è¿‡æ»¤**: è‡ªå®šä¹‰è¿‡æ»¤ä¸éœ€è¦çš„å†…å®¹
- ğŸ“± **å“åº”å¼è®¾è®¡**: è‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
- ğŸ” **ç”¨æˆ·è®¤è¯**: æ”¯æŒ Danbooru ç”¨æˆ·åå’Œ API å¯†é’¥è®¤è¯
- â­ **æ”¶è—åŠŸèƒ½**: æ·»åŠ å’Œç§»é™¤å›¾åƒæ”¶è—ï¼Œæ”¯æŒäº‘ç«¯åŒæ­¥
- ğŸŒ **ç½‘ç»œæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ä¸ Danbooru çš„ç½‘ç»œè¿æ¥çŠ¶æ€
- ğŸˆ³ **ä¸­è‹±å¯¹ç…§**: æ”¯æŒæ ‡ç­¾ä¸­è‹±æ–‡äº’è¯‘å’Œä¸­æ–‡æœç´¢åŒ¹é…
- âš™ï¸ **é«˜çº§è®¾ç½®**: è°ƒè¯•æ¨¡å¼ã€é¡µé¢å¤§å°è®¾ç½®ã€ç¼“å­˜é…ç½®
- ğŸ–¼ï¸ **æŸ¥çœ‹å¤§å›¾**: æ”¯æŒç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å…¨å°ºå¯¸å¤§å›¾
- âœï¸ **ç¼–è¾‘æç¤ºè¯**: æ”¯æŒå¯¹æç¤ºè¯è¿›è¡Œå¢åŠ ã€åˆ å‡æ ‡ç­¾ï¼Œå¹¶æä¾›æ™ºèƒ½è¡¥å…¨å’Œä¸€é”®è¿˜åŸåŠŸèƒ½
- ğŸ“‹ **ä¸€é”®å¤åˆ¶**: æ–¹ä¾¿åœ°ä¸€é”®å¤åˆ¶æ‰€æœ‰æ ‡ç­¾
- ğŸ”„ **äººç‰©ç‰¹å¾æ›¿æ¢**: æ–°å¢ `Character Feature Swap` èŠ‚ç‚¹ï¼Œåˆ©ç”¨ LLM æ™ºèƒ½æ›¿æ¢æç¤ºè¯ä¸­çš„äººç‰©ç‰¹å¾ã€‚
- ğŸ“š **æç¤ºè¯é€‰æ‹©å™¨**: æ–°å¢ `Prompt Selector` èŠ‚ç‚¹ï¼Œç”¨äºåˆ†ç±»ç®¡ç†å’Œé€‰æ‹©å¸¸ç”¨æç¤ºè¯ã€‚

### æ–°å¢èŠ‚ç‚¹è¯¦ç»†è¯´æ˜

#### ğŸŒŸ äººç‰©ç‰¹å¾æ›¿æ¢ (Character Feature Swap)

è¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰API æ¥æ™ºèƒ½æ›¿æ¢æç¤ºè¯ä¸­äººç‰©ç›¸å…³ç‰¹å¾çš„èŠ‚ç‚¹ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥å°†ä¸€å¼ å›¾ä¸­çš„è§’è‰²ç‰¹å¾ï¼ˆå¦‚å‘å‹ã€çœ¼ç›é¢œè‰²ã€æœè£…ç­‰ï¼‰æ›¿æ¢ä¸ºä½ æƒ³è¦çš„ç‰¹å¾ï¼ŒåŒæ—¶å°½å¯èƒ½ä¿ç•™åŸå§‹æ„å›¾ã€å§¿åŠ¿å’Œç¯å¢ƒã€‚

##### åŠŸèƒ½

-   **æ™ºèƒ½æ›¿æ¢**ï¼šé€šè¿‡ LLM ç†è§£å¹¶æ›¿æ¢æç¤ºè¯ä¸­çš„äººç‰©ç‰¹å¾ã€‚
-   **å¤šæ¸ é“æ”¯æŒ**ï¼šæ”¯æŒ OpenRouter, Gemini API, DeepSeek, ä»¥åŠå…¶ä»–å…¼å®¹ OpenAI çš„ APIã€‚åŒæ—¶æ”¯æŒé€šè¿‡ `@google/gemini-cli` åœ¨æœ¬åœ°æ‰§è¡Œã€‚
-   **é«˜åº¦å¯é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰ LLM API æœåŠ¡ã€æ¨¡å‹å’Œ AI æç¤ºã€‚
-   **é¢„è®¾ç®¡ç†**ï¼šå¯ä»¥ä¿å­˜å’Œåˆ‡æ¢å¤šç»„è¦æ›¿æ¢çš„â€œç‰¹å¾ç±»åˆ«â€ï¼Œæ–¹ä¾¿ä¸åŒåœºæ™¯ä½¿ç”¨ã€‚
-   **æ˜“äºä½¿ç”¨**ï¼šèŠ‚ç‚¹ä¸Šæä¾›ç‹¬ç«‹çš„â€œè®¾ç½®â€æŒ‰é’®ï¼Œæ–¹ä¾¿é…ç½® API Key ç­‰æ•æ„Ÿä¿¡æ¯ï¼Œå¹¶æä¾›è¿æ¥æµ‹è¯•åŠŸèƒ½ã€‚

##### å¦‚ä½•ä½¿ç”¨

1.  **æ·»åŠ èŠ‚ç‚¹**ï¼šåœ¨ ComfyUI ä¸­ï¼Œæ·»åŠ  `Danbooru > äººç‰©ç‰¹å¾æ›¿æ¢ (Character Feature Swap)` èŠ‚ç‚¹ã€‚
2.  **é…ç½®API**ï¼š
    -   ç‚¹å‡»èŠ‚ç‚¹ä¸Šçš„ **â€œè®¾ç½® (Settings)â€** æŒ‰é’®ã€‚
    -   åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©ä½ è¦ä½¿ç”¨çš„ `APIæ¸ é“`ã€‚
    -   æ ¹æ®æ‰€é€‰æ¸ é“ï¼Œå¡«å…¥ä½ çš„ API URL å’Œ API Keyã€‚
        -   **OpenRouter**: `https://openrouter.ai/api/v1`
        -   **Gemini API**: `https://generativelanguage.googleapis.com/v1beta`
        -   **DeepSeek**: `https://api.deepseek.com/v1`
        -   **OpenAIå…¼å®¹**: å¡«å…¥ä½ çš„æœåŠ¡åœ°å€ï¼Œä¾‹å¦‚ `http://localhost:11434/v1`
        -   **Gemini CLI**: æ— éœ€ URL å’Œ Keyï¼Œä½†éœ€è¦é¢„å…ˆå®‰è£… `gemini-cli`ã€‚
    -   ç‚¹å‡» **â€œè·å–æ¨¡å‹åˆ—è¡¨â€** å¹¶é€‰æ‹©ä¸€ä¸ªä½ åå¥½çš„æ¨¡å‹ã€‚
    -   ç‚¹å‡» **â€œæµ‹è¯•è¿æ¥â€** å’Œ **â€œæµ‹è¯•å›å¤â€** ç¡®ä¿é…ç½®æ­£ç¡®ã€‚
    -   ç‚¹å‡» **â€œä¿å­˜â€**ã€‚
3.  **è¿æ¥è¾“å…¥**ï¼š
    -   `original_prompt`ï¼šè¾“å…¥ä½ ä» Danbooru Gallery æˆ–å…¶ä»–åœ°æ–¹è·å–çš„ã€åŒ…å«å®Œæ•´äººç‰©ç‰¹å¾çš„åŸå§‹æç¤ºè¯ã€‚
    -   `character_prompt`ï¼šè¾“å…¥ä½ æƒ³è¦æ›¿æ¢æˆçš„æ–°çš„äººç‰©ç‰¹å¾æç¤ºè¯ï¼Œä¾‹å¦‚ä½ è‡ªå·±çš„è™šæ‹Ÿè§’è‰²çš„ç‰¹å¾ã€‚
4.  **è·å–è¾“å‡º**ï¼š
    -   `new_prompt` è¾“å‡ºçš„å°±æ˜¯ç»è¿‡ LLM å¤„ç†åã€æ›¿æ¢äº†ç‰¹å¾çš„æ–°æç¤ºè¯ã€‚ä½ å¯ä»¥å°†å®ƒè¿æ¥åˆ°ä½ çš„æç¤ºè¯ç¼–ç å™¨ï¼ˆå¦‚ `CLIPTextEncode`ï¼‰ä¸­ä½¿ç”¨ã€‚

> [!NOTE]
> å¦‚æœé€‰æ‹©ä½¿ç”¨ `Gemini CLI` æ¸ é“ï¼Œä½ éœ€è¦å…ˆé€šè¿‡ `npm` å…¨å±€å®‰è£…å®ƒï¼š
> `npm install -g @google/gemini-cli`
> å¹¶ç¡®ä¿ `gemini` å‘½ä»¤åœ¨ä½ çš„ç³»ç»Ÿ `PATH` ä¸­ã€‚

#### ğŸ“š æç¤ºè¯é€‰æ‹©å™¨ (Prompt Selector)

è¿™æ˜¯ä¸€ä¸ªç”¨äºåˆ†ç±»ã€ç®¡ç†å’Œé€‰æ‹©å¸¸ç”¨æç¤ºè¯çš„èŠ‚ç‚¹ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥æ‰“é€ è‡ªå·±çš„æç¤ºè¯åº“ï¼Œæé«˜å·¥ä½œæµæ•ˆç‡ã€‚

##### åŠŸèƒ½

-   **åˆ†ç±»ç®¡ç†**ï¼šåˆ›å»ºå¤šä¸ªåˆ†ç±»æ¥ç»„ç»‡ä½ çš„æç¤ºè¯ï¼Œä¾‹å¦‚â€œè´¨é‡ä¸²â€ã€â€œç”»é£ä¸²â€ã€â€œLORAâ€ç­‰ã€‚
-   **é¢„è§ˆå›¾æ”¯æŒ**ï¼šä¸ºæ¯ä¸ªæç¤ºè¯æ¡ç›®ä¸Šä¼ ä¸€å¼ é¢„è§ˆå›¾ï¼Œæ–¹ä¾¿ç›´è§‚é€‰æ‹©ã€‚
-   **å¯¼å…¥/å¯¼å‡º**ï¼šæ”¯æŒé€šè¿‡ `.zip` æ–‡ä»¶å®Œæ•´åœ°å¯¼å…¥å’Œå¯¼å‡ºæ•´ä¸ªæç¤ºè¯åº“ï¼Œæ–¹ä¾¿å¤‡ä»½å’Œåˆ†äº«ã€‚
-   **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡åˆ é™¤å’Œç§»åŠ¨æç¤ºè¯ã€‚
-   **æ’åºä¸æ”¶è—**ï¼šæ”¯æŒæ‹–æ‹½æ’åºå’Œæ ‡è®°å¸¸ç”¨æç¤ºè¯ã€‚
-   **çµæ´»æ‹¼æ¥**ï¼šå¯ä»¥å°†é€‰æ‹©çš„æç¤ºè¯ä¸ä¸Šæ¸¸èŠ‚ç‚¹ï¼ˆå¦‚ `Danbooru Gallery`ï¼‰çš„è¾“å‡ºæ‹¼æ¥åœ¨ä¸€èµ·ã€‚

##### å¦‚ä½•ä½¿ç”¨

1.  **æ·»åŠ èŠ‚ç‚¹**ï¼šåœ¨ ComfyUI ä¸­ï¼Œæ·»åŠ  `Danbooru > æç¤ºè¯é€‰æ‹©å™¨ (Prompt Selector)` èŠ‚ç‚¹ã€‚
2.  **ç®¡ç†è¯åº“**ï¼š
    -   åŒå‡»èŠ‚ç‚¹æ‰“å¼€ç®¡ç†ç•Œé¢ã€‚
    -   é€šè¿‡ **â€œæ·»åŠ åˆ†ç±»â€**ã€**â€œæ·»åŠ æç¤ºè¯â€** æ¥æ„å»ºä½ çš„è¯åº“ã€‚
    -   ç‚¹å‡»æç¤ºè¯æ¡ç›®å³ä¾§çš„å›¾ç‰‡å›¾æ ‡å¯ä»¥ä¸Šä¼ é¢„è§ˆå›¾ã€‚
    -   ä½¿ç”¨ **â€œå¯¼å…¥/å¯¼å‡ºâ€** æŒ‰é’®æ¥å¤‡ä»½æˆ–æ¢å¤ä½ çš„æ•°æ®ã€‚
3.  **é€‰æ‹©æç¤ºè¯**ï¼š
    -   åœ¨ç•Œé¢ä¸­ç‚¹å‡»ä½ æƒ³è¦ä½¿ç”¨çš„æç¤ºè¯ï¼Œå®ƒä»¬ä¼šè¢«æ·»åŠ åˆ°ä¸‹æ–¹çš„â€œå·²é€‰æç¤ºè¯â€åŒºåŸŸã€‚
    -   ä½ å¯ä»¥ç›´æ¥åœ¨â€œå·²é€‰æç¤ºè¯â€åŒºåŸŸè°ƒæ•´é¡ºåºæˆ–åˆ é™¤ã€‚
4.  **è¿æ¥è¾“å…¥ (å¯é€‰)**ï¼š
    -   `prefix_prompt`ï¼šå¯ä»¥è¿æ¥ä¸€ä¸ªä¸Šæ¸¸çš„æç¤ºè¯è¾“å‡ºï¼ˆä¾‹å¦‚ `Danbooru Gallery`ï¼‰ï¼Œé€‰æ‹©å™¨ä¸­çš„æç¤ºè¯ä¼šè‡ªåŠ¨è¿½åŠ åœ¨åé¢ã€‚
5.  **è·å–è¾“å‡º**ï¼š
    -   `prompt` è¾“å‡ºæ‹¼æ¥å¥½çš„æœ€ç»ˆæç¤ºè¯ã€‚

### å¿«é€Ÿå®‰è£…

#### æ–¹æ³•ä¸€ï¼šComfyUI Manager å®‰è£…ï¼ˆæœ€æ¨èï¼‰

1. åœ¨ ComfyUI ä¸­æ‰“å¼€ Manager ç•Œé¢
2. ç‚¹å‡» "Install Custom Nodes"
3. æœç´¢ "Danbooru Gallery" æˆ– "ComfyUI-Danbooru-Gallery"
4. ç‚¹å‡» "Install" æŒ‰é’®
5. é‡å¯ ComfyUI

#### æ–¹æ³•äºŒï¼šè‡ªåŠ¨å®‰è£…

```bash
# 1. å°†æ’ä»¶æ”¾åˆ° ComfyUI/custom_nodes/ ç›®å½•
git clone https://github.com/comfyui-extensions/comfyui-danbooru-gallery.git

# 2. è¿è¡Œå®‰è£…è„šæœ¬
cd comfyui-danbooru-gallery
python install.py

# 3. é‡å¯ ComfyUI
```

#### æ–¹æ³•ä¸‰ï¼šæ‰‹åŠ¨å®‰è£…

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### ç³»ç»Ÿè¦æ±‚

- **Python**: 3.8+
- **ComfyUI**: æœ€æ–°ç‰ˆæœ¬

### æ ¸å¿ƒä¾èµ–

- `requests>=2.28.0` - HTTPè¯·æ±‚åº“
- `aiohttp>=3.8.0` - å¼‚æ­¥HTTPå®¢æˆ·ç«¯
- `Pillow>=9.0.0` - å›¾åƒå¤„ç†åº“
- `torch>=1.12.0` - PyTorchæ¡†æ¶
- `numpy>=1.21.0` - æ•°å€¼è®¡ç®—åº“

### åŸºæœ¬ä½¿ç”¨

1. åœ¨ ComfyUI ä¸­æ·»åŠ  "Danbooru Images Gallery" èŠ‚ç‚¹
2. åŒå‡»èŠ‚ç‚¹æ‰“å¼€ç”»å»Šç•Œé¢
3. è¾“å…¥æœç´¢æ ‡ç­¾ï¼ˆå¦‚ï¼š`1girl blue_eyes smile`ï¼‰
4. é€‰æ‹©è¯„åˆ†è¿‡æ»¤å™¨å¹¶æœç´¢
5. ç‚¹å‡»å›¾åƒé€‰æ‹©å¹¶å¯¼å…¥åˆ°èŠ‚ç‚¹

### è¯¦ç»†åŠŸèƒ½è¯´æ˜

#### ğŸ” ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- æ”¯æŒ Danbooru ç”¨æˆ·åå’Œ API å¯†é’¥è®¤è¯
- è®¤è¯åå¯ä½¿ç”¨æ”¶è—åŠŸèƒ½å’Œé«˜çº§åŠŸèƒ½
- è‡ªåŠ¨éªŒè¯è®¤è¯çŠ¶æ€å’Œç½‘ç»œè¿æ¥

#### â­ æ”¶è—åŠŸèƒ½
- æ·»åŠ /ç§»é™¤å›¾åƒæ”¶è—
- æ”¯æŒäº‘ç«¯åŒæ­¥æ”¶è—åˆ—è¡¨
- æœ¬åœ°ç¼“å­˜æ”¶è—çŠ¶æ€

#### ğŸŒ ç½‘ç»œè¿æ¥æ£€æµ‹
- è‡ªåŠ¨æ£€æµ‹ä¸ Danbooru æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€
- æ˜¾ç¤ºç½‘ç»œé”™è¯¯ä¿¡æ¯å’Œè¶…æ—¶å¤„ç†

#### âš™ï¸ é«˜çº§è®¾ç½®
- **å¤šè¯­è¨€æ”¯æŒ**: ä¸­è‹±æ–‡ç•Œé¢åˆ‡æ¢
- **é»‘åå•ç®¡ç†**: è‡ªå®šä¹‰è¿‡æ»¤ä¸éœ€è¦çš„æ ‡ç­¾
- **æç¤ºè¯è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤æ°´å°ã€ç”¨æˆ·åç­‰æ ‡ç­¾
- **è°ƒè¯•æ¨¡å¼**: å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º
- **é¡µé¢å¤§å°**: è‡ªå®šä¹‰æ¯é¡µæ˜¾ç¤ºçš„å›¾åƒæ•°é‡

#### ğŸˆ³ ä¸­è‹±å¯¹ç…§ç³»ç»Ÿ
- **ä¸­è‹±äº’è¯‘**: è‡ªåŠ¨ç¿»è¯‘è‹±æ–‡æ ‡ç­¾ä¸ºä¸­æ–‡æè¿°
- **ä¸­æ–‡æœç´¢**: æ”¯æŒè¾“å…¥ä¸­æ–‡ç›´æ¥æœç´¢å¯¹åº”è‹±æ–‡æ ‡ç­¾
- **æ¨¡ç³ŠåŒ¹é…**: æ”¯æŒä¸­æ–‡æ‹¼éŸ³å’Œéƒ¨åˆ†å­—ç¬¦åŒ¹é…
- **æ‰¹é‡ç¿»è¯‘**: é«˜æ•ˆçš„æ‰¹é‡æ ‡ç­¾ç¿»è¯‘å¤„ç†
- **å®æ—¶æç¤º**: è‡ªåŠ¨è¡¥å…¨æ—¶æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘
- **å¤šæ•°æ®æº**: æ”¯æŒJSONå’ŒCSVæ ¼å¼çš„ç¿»è¯‘æ•°æ®

### ç¿»è¯‘åŠŸèƒ½è¯¦è§£

#### æ”¯æŒçš„ç¿»è¯‘æ•°æ®æ ¼å¼
- **JSONæ ¼å¼** (`zh_cn/all_tags_cn.json`): è‹±æ–‡æ ‡ç­¾åˆ°ä¸­æ–‡çš„é”®å€¼å¯¹æ˜ å°„
- **CSVæ ¼å¼** (`zh_cn/danbooru.csv`): è‹±æ–‡æ ‡ç­¾,ä¸­æ–‡ç¿»è¯‘ çš„CSVæ–‡ä»¶
- **è§’è‰²CSV** (`zh_cn/wai_characters.csv`): ä¸­æ–‡è§’è‰²å,è‹±æ–‡æ ‡ç­¾ çš„CSVæ–‡ä»¶

#### ç¿»è¯‘åŠŸèƒ½ç‰¹æ€§
- **æ™ºèƒ½æœç´¢**: æ”¯æŒç²¾ç¡®åŒ¹é…ã€å‰ç¼€åŒ¹é…ã€åŒ…å«åŒ¹é…å’Œæ¨¡ç³ŠåŒ¹é…
- **ç¼“å­˜ä¼˜åŒ–**: ç¿»è¯‘ç»“æœç¼“å­˜ï¼Œæé«˜å“åº”é€Ÿåº¦
- **ä¸‹åˆ’çº¿å¤„ç†**: è‡ªåŠ¨å¤„ç†æœ‰æ— ä¸‹åˆ’çº¿çš„æ ‡ç­¾å˜ä½“
- **ä¸­æ–‡ç´¢å¼•**: æ„å»ºä¸­æ–‡å­—ç¬¦ç´¢å¼•ï¼Œæ”¯æŒå¿«é€Ÿæœç´¢
- **æƒé‡æ’åº**: æ ¹æ®åŒ¹é…åº¦ä¸ºæœç´¢ç»“æœæ’åº

#### ä½¿ç”¨æ–¹æ³•
1. **ä¸­æ–‡æœç´¢**: åœ¨æœç´¢æ¡†ä¸­ç›´æ¥è¾“å…¥ä¸­æ–‡ï¼ˆå¦‚"å¥³å­©"ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…å¯¹åº”çš„è‹±æ–‡æ ‡ç­¾
2. **ç¿»è¯‘æ˜¾ç¤º**: åœ¨ä¸­æ–‡ç•Œé¢ä¸‹ï¼Œæ ‡ç­¾æ‚¬æµ®æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨ä¼šæ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘
3. **æ™ºèƒ½è¡¥å…¨**: è¾“å…¥è‹±æ–‡æ ‡ç­¾æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘

### æ ‡ç­¾è¯­æ³•

```
æ™®é€šæ ‡ç­¾ï¼štag_name
æ’é™¤æ ‡ç­¾ï¼š-tag_name  
å¤šæ ‡ç­¾ç»„åˆï¼štag1 tag2 tag3
ç¤ºä¾‹ï¼š1girl blue_eyes smile -blurry
```

### é¡¹ç›®ç»“æ„

```
ComfyUI-Danbooru-Gallery/
â”œâ”€â”€ __init__.py                     # æ’ä»¶å…¥å£
â”œâ”€â”€ danbooru_gallery/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ danbooru_gallery.py         # Danbooruç”»å»Šåç«¯é€»è¾‘
â”œâ”€â”€ character_feature_swap/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ character_feature_swap.py   # äººç‰©ç‰¹å¾æ›¿æ¢åç«¯é€»è¾‘
â”œâ”€â”€ prompt_selector/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ prompt_selector.py          # æç¤ºè¯é€‰æ‹©å™¨åç«¯é€»è¾‘
â”œâ”€â”€ install.py                      # æ™ºèƒ½å®‰è£…è„šæœ¬
â”œâ”€â”€ requirements.txt                # ä¾èµ–æ¸…å•
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ danbooru_gallery.js         # Danbooruç”»å»Šå‰ç«¯
â”‚   â”œâ”€â”€ character_feature_swap.js   # äººç‰©ç‰¹å¾æ›¿æ¢å‰ç«¯
â”‚   â””â”€â”€ prompt_selector.js          # æç¤ºè¯é€‰æ‹©å™¨å‰ç«¯
â”œâ”€â”€ danbooru_gallery/zh_cn/         # ä¸­æ–‡ç¿»è¯‘æ•°æ®
â”‚   â”œâ”€â”€ all_tags_cn.json
â”‚   â”œâ”€â”€ danbooru.csv
â”‚   â””â”€â”€ wai_characters.csv
â””â”€â”€ README.md                       # è¯´æ˜æ–‡æ¡£
```

### æ•…éšœæ’é™¤

- **è¿æ¥é—®é¢˜**: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ API å¯†é’¥
- **å›¾åƒåŠ è½½å¤±è´¥**: ç¡®è®¤ç£ç›˜ç©ºé—´å’Œå›¾åƒ URL
- **æ’ä»¶ä¸æ˜¾ç¤º**: æ£€æŸ¥ç›®å½•ä½ç½®å’Œä¾èµ–å®‰è£…
- **æ€§èƒ½é—®é¢˜**: æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

---

## English Version

### Overview

A ComfyUI plugin for browsing and importing images from Danbooru using its API, with features including tag-based search, image preview, content filtering, and more.

### Key Features

- ğŸ” **Tag Search**: Precise search using Danbooru tags
- ğŸ“„ **Pagination**: Efficient pagination for better browsing
- ğŸ’¡ **Intelligent Autocomplete**: Autocomplete popular tags while typing
- ğŸ¨ **Image Preview**: High-quality image preview and download
- ğŸ”§ **Settings**: Multi-language, blacklist, and prompt filtering
- ğŸ¯ **ComfyUI Integration**: Seamless integration with ComfyUI workflow
- ğŸŒŠ **Waterfall Layout**: Responsive waterfall image arrangement
- ğŸ“Š **Rating Filter**: Filter content by image rating
- ğŸ·ï¸ **Category Selection**: Choose which tag categories to output
- ğŸ“ **Formatting Options**: Support bracket escaping and underscore replacement
- ğŸ–ï¸ **Ranking Mode**: Display images sorted by popularity
- ğŸš« **Blacklist Filter**: Custom filtering of unwanted content
- ğŸ“± **Responsive Design**: Adaptive to different screen sizes
- ğŸ” **User Authentication**: Support for Danbooru username and API key authentication
- â­ **Favorites**: Add and remove image favorites with cloud synchronization
- ğŸŒ **Network Detection**: Automatic detection of network connection to Danbooru
- ğŸˆ³ **Chinese-English Bilingual**: Support for tag translation and Chinese search matching
- âš™ï¸ **Advanced Settings**: Debug mode, page size settings, cache configuration
- ğŸ–¼ï¸ **View Full Image**: Click on an image to view the full-size version
- âœï¸ **Edit Prompts**: Add or remove tags from prompts, with intelligent autocomplete and one-click restore
- ğŸ“‹ **One-Click Copy**: Easily copy all tags with a single click
- ğŸ”„ **Character Feature Swap**: Adds a `Character Feature Swap` node to intelligently replace character features in prompts using an LLM.
- ğŸ“š **Prompt Selector**: Adds a `Prompt Selector` node for categorizing, managing, and selecting frequently used prompts.

### New Nodes in Detail

#### ğŸŒŸ Character Feature Swap

This node utilizes a Large Language Model (LLM) API to intelligently replace character-related features in a prompt. You can use it to swap features from one image's prompt (like hair style, eye color, clothing) with your desired features, while preserving the original composition, pose, and environment as much as possible.

##### Features

-   **Intelligent Swapping**: Understands and replaces character features in prompts via an LLM.
-   **Multi-Channel Support**: Supports OpenRouter, Gemini API, DeepSeek, and other OpenAI-compatible APIs. Also supports local execution via `@google/gemini-cli`.
-   **Highly Configurable**: Allows customization of the LLM API service, model, and AI prompt.
-   **Preset Management**: Save and switch between multiple sets of "feature categories" to replace, making it convenient for different scenarios.
-   **Easy to Use**: A dedicated "Settings" button on the node simplifies the configuration of sensitive information like API keys and includes connection testing functionality.

##### How to Use

1.  **Add Node**: In ComfyUI, add the `Danbooru > Character Feature Swap` node.
2.  **Configure API**:
    -   Click the **"Settings"** button on the node.
    -   In the dialog, select the `API Channel` you want to use.
    -   Enter your API URL and API Key based on the selected channel.
        -   **OpenRouter**: `https://openrouter.ai/api/v1`
        -   **Gemini API**: `https://generativelanguage.googleapis.com/v1beta`
        -   **DeepSeek**: `https://api.deepseek.com/v1`
        -   **OpenAI-compatible**: Enter your service address, e.g., `http://localhost:11434/v1`
        -   **Gemini CLI**: No URL or Key needed, but requires `gemini-cli` to be pre-installed.
    -   Click **"Get Model List"** and choose your preferred model.
    -   Click **"Test Connection"** and **"Test Response"** to ensure the configuration is correct.
    -   Click **"Save"**.
3.  **Connect Inputs**:
    -   `original_prompt`: Input the original prompt containing full character features, obtained from Danbooru Gallery or elsewhere.
    -   `character_prompt`: Input the new character features you want to swap in, such as your own virtual character's features.
4.  **Get Output**:
    -   `new_prompt` outputs the new prompt with the replaced features, processed by the LLM. You can connect it to your prompt encoder (e.g., `CLIPTextEncode`).

> [!NOTE]
> If you choose the `Gemini CLI` channel, you need to install it globally via `npm` first:
> `npm install -g @google/gemini-cli`
> And ensure the `gemini` command is in your system's `PATH`.

#### ğŸ“š Prompt Selector

This node is for categorizing, managing, and selecting frequently used prompts. You can use it to build your own prompt library and improve your workflow efficiency.

##### Features

-   **Category Management**: Create multiple categories to organize your prompts, such as "Quality Tags," "Style Tags," "LORAs," etc.
-   **Preview Image Support**: Upload a preview image for each prompt entry for intuitive selection.
-   **Import/Export**: Supports importing and exporting the entire prompt library via a `.zip` file for easy backup and sharing.
-   **Batch Operations**: Supports batch deletion and moving of prompts.
-   **Sorting and Favorites**: Supports drag-and-drop sorting and marking frequently used prompts.
-   **Flexible Concatenation**: The selected prompts can be concatenated with the output of an upstream node (like `Danbooru Gallery`).

##### How to Use

1.  **Add Node**: In ComfyUI, add the `Danbooru > Prompt Selector` node.
2.  **Manage Library**:
    -   Double-click the node to open the management interface.
    -   Build your library using **"Add Category"** and **"Add Prompt"**.
    -   Click the image icon on the right of a prompt entry to upload a preview image.
    -   Use the **"Import/Export"** buttons to back up or restore your data.
3.  **Select Prompts**:
    -   Click the prompts you want to use in the interface, and they will be added to the "Selected Prompts" area below.
    -   You can reorder or delete them directly in the "Selected Prompts" area.
4.  **Connect Input (Optional)**:
    -   `prefix_prompt`: You can connect an upstream prompt output (e.g., from `Danbooru Gallery`), and the prompts from the selector will be appended to it.
5.  **Get Output**:
    -   `prompt` outputs the final concatenated prompt.

### Quick Installation

#### Method 1: ComfyUI Manager Installation (Most Recommended)

1. Open Manager interface in ComfyUI
2. Click "Install Custom Nodes"
3. Search for "Danbooru Gallery" or "ComfyUI-Danbooru-Gallery"
4. Click "Install" button
5. Restart ComfyUI

#### Method 2: Automatic Installation

```bash
# 1. Clone to ComfyUI/custom_nodes/ directory
git clone https://github.com/comfyui-extensions/comfyui-danbooru-gallery.git

# 2. Run installation script
cd comfyui-danbooru-gallery
python install.py

# 3. Restart ComfyUI
```

#### Method 3: Manual Installation

```bash
# Install dependencies
pip install -r requirements.txt
```

### System Requirements

- **Python**: 3.8+
- **ComfyUI**: Latest version

### Core Dependencies

- `requests>=2.28.0` - HTTP request library
- `aiohttp>=3.8.0` - Async HTTP client
- `Pillow>=9.0.0` - Image processing library
- `torch>=1.12.0` - PyTorch framework
- `numpy>=1.21.0` - Numerical computing library

### Basic Usage

1. Add "Danbooru Images Gallery" node in ComfyUI
2. Double-click the node to open gallery interface
3. Enter search tags (e.g., `1girl blue_eyes smile`)
4. Select rating filter and search
5. Click images to select and import to node

### Detailed Features

#### ğŸ” User Authentication System
- Support for Danbooru username and API key authentication
- Access to favorites and advanced features after authentication
- Automatic authentication status and network connection verification

#### â­ Favorites Feature
- Add/remove image favorites
- Cloud synchronization of favorites list
- Local caching of favorite status

#### ğŸŒ Network Connection Detection
- Automatic detection of connection status to Danbooru server
- Display network error messages and timeout handling

#### âš™ï¸ Advanced Settings
- **Multi-language Support**: Chinese/English interface switching
- **Blacklist Management**: Custom filtering of unwanted tags
- **Prompt Filtering**: Automatic filtering of watermarks, usernames, etc.
- **Debug Mode**: Enable detailed logging output
- **Page Size**: Customize number of images displayed per page

#### ğŸˆ³ Chinese-English Bilingual System
- **Bidirectional Translation**: Automatic translation of English tags to Chinese descriptions
- **Chinese Search**: Support for searching with Chinese input to find corresponding English tags
- **Fuzzy Matching**: Support for Chinese pinyin and partial character matching
- **Batch Translation**: Efficient batch tag translation processing
- **Real-time Hints**: Display Chinese translations during autocomplete
- **Multiple Data Sources**: Support for JSON and CSV format translation data

### Translation Features

#### Supported Translation Data Formats
- **JSON Format** (`zh_cn/all_tags_cn.json`): English tag to Chinese key-value mapping
- **CSV Format** (`zh_cn/danbooru.csv`): English tag, Chinese translation CSV file
- **Character CSV** (`zh_cn/wai_characters.csv`): Chinese character name, English tag CSV file

#### Translation System Features
- **Intelligent Search**: Support for exact match, prefix match, contains match, and fuzzy match
- **Cache Optimization**: Translation result caching for improved response speed
- **Underscore Handling**: Automatic handling of tag variants with/without underscores
- **Chinese Indexing**: Build Chinese character index for fast searching
- **Weight Sorting**: Sort search results by matching degree

#### Usage
1. **Chinese Search**: Enter Chinese directly in search box (e.g., "å¥³å­©"), system will automatically match corresponding English tags
2. **Translation Display**: In Chinese interface, tag tooltips and autocomplete show Chinese translations
3. **Smart Completion**: When typing English tags, automatically display corresponding Chinese translations

### Tag Syntax

```
Normal tags: tag_name
Exclude tags: -tag_name
Multiple tags: tag1 tag2 tag3
Example: 1girl blue_eyes smile -blurry
```

### Project Structure

```
ComfyUI-Danbooru-Gallery/
â”œâ”€â”€ __init__.py                     # Plugin entry point
â”œâ”€â”€ danbooru_gallery/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ danbooru_gallery.py         # Danbooru Gallery backend logic
â”œâ”€â”€ character_feature_swap/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ character_feature_swap.py   # Character Feature Swap backend logic
â”œâ”€â”€ prompt_selector/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ prompt_selector.py          # Prompt Selector backend logic
â”œâ”€â”€ install.py                      # Smart installation script
â”œâ”€â”€ requirements.txt                # Dependency list
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ danbooru_gallery.js         # Danbooru Gallery frontend
â”‚   â”œâ”€â”€ character_feature_swap.js   # Character Feature Swap frontend
â”‚   â””â”€â”€ prompt_selector.js          # Prompt Selector frontend
â”œâ”€â”€ danbooru_gallery/zh_cn/         # Chinese translation data
â”‚   â”œâ”€â”€ all_tags_cn.json
â”‚   â”œâ”€â”€ danbooru.csv
â”‚   â””â”€â”€ wai_characters.csv
â””â”€â”€ README.md                       # Documentation
```

### Troubleshooting

- **Connection Issues**: Check network and API key
- **Image Loading Fails**: Verify disk space and image URLs
- **Plugin Not Showing**: Check directory location and dependencies
- **Performance Issues**: Check console logs for detailed information

---

## å¼€å‘ | Development

### æŠ€æœ¯æ ˆ | Tech Stack

- **Backend**: Python + aiohttp + requests
- **Frontend**: JavaScript + ComfyUI UI
- **Cache**: File system cache
- **API**: Danbooru REST API

### è´¡çŒ® | Contributing

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼  
Issues and Pull Requests are welcome!

### è®¸å¯è¯ | License

MIT License

### è‡´è°¢ | Acknowledgments

- æ„Ÿè°¢ Danbooru æä¾›ä¼˜ç§€çš„ API | Thanks to Danbooru for the excellent API
- æ„Ÿè°¢ ComfyUI ç¤¾åŒº | Thanks to the ComfyUI community
- å‚è€ƒäº† ComfyUI_Civitai_Gallery é¡¹ç›® | Inspired by ComfyUI_Civitai_Gallery project

#### ç¿»è¯‘æ–‡ä»¶æ¥æº | Translation Data Sources

- [danbooru-diffusion-prompt-builder](https://github.com/wfjsw/danbooru-diffusion-prompt-builder) - Danbooru æ ‡ç­¾ç¿»è¯‘æ•°æ®
- [zh_CN-Tags](https://github.com/Yellow-Rush/zh_CN-Tags) - ä¸­æ–‡æ ‡ç­¾æ•°æ®
- [ComfyUI_Mira](https://github.com/mirabarukaso/ComfyUI_Mira) - è§’è‰²ç¿»è¯‘æ•°æ®


