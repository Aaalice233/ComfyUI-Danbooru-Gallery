# 下拉菜单选择组功能

## 功能概述

组执行管理器现在支持通过下拉菜单自动选择工作流中的组，无需手动输入组名。

## 新增功能

### 1. 自动获取工作流组名称

节点会自动扫描工作流中的所有组（Groups），并提供给用户选择。

**实现方式**:
```javascript
// 获取工作流中所有组的名称
getAllGroupNames() {
    if (!app.graph || !app.graph._groups) {
        return [];
    }
    return app.graph._groups
        .filter(g => g && g.title) // 过滤掉无效组
        .map(g => g.title)
        .sort(); // 按字母顺序排序
}
```

### 2. 添加组 - 下拉菜单选择

点击底部的"添加组"按钮时，会弹出下拉菜单显示所有可用的组。

**特性**:
- 显示所有工作流中的组名称
- 按字母顺序排序
- 自动检查重复，防止添加同名组
- 如果工作流中没有组，会显示提示信息

**使用方法**:
1. 点击底部的 `+ 添加组` 按钮
2. 从下拉菜单中选择要添加的组
3. 点击选择的组名即可添加

### 3. 修改组 - 点击组名更换

点击已添加组的名称，可以打开下拉菜单更换组。

**特性**:
- 点击组名文本或其旁边的下拉箭头图标
- 当前选中的组会在下拉菜单中用绿点标记
- 选择新组名后立即更新

**使用方法**:
1. 点击组条目中的组名（序号徽章右侧的文本）
2. 从下拉菜单中选择新的组名
3. 点击确认更换

### 4. 下拉菜单UI

**视觉设计**:
- 居中显示的现代化下拉菜单
- 半透明遮罩背景
- 蓝色高亮hover效果
- 绿点标记当前选中的组
- 支持滚动（超过8个组时显示滚动条）

**交互特性**:
- 鼠标hover时高亮显示
- 点击选项进行选择
- 点击菜单外部关闭菜单
- 平滑的视觉反馈

### 5. 视觉提示

**组名旁的下拉箭头**:
- 每个组名后面显示一个小的蓝色向下箭头（▼）
- 表示组名可点击更换
- 提升用户体验和可发现性

## 技术实现

### 状态管理

```javascript
// 下拉菜单状态
this.dropdownVisible = false;      // 下拉菜单是否可见
this.dropdownIndex = -1;           // 正在编辑的组索引 (-1 表示添加新组)
this.dropdownHoverIndex = -1;      // 鼠标悬停的下拉项索引
this.dropdownScrollOffset = 0;     // 下拉菜单滚动偏移
```

### 下拉菜单配置

```javascript
const dropdownItemHeight = 32;     // 每项高度
const dropdownMaxItems = 8;        // 最多显示8项
const dropdownWidth = 250;         // 菜单宽度
```

### 事件处理

1. **onMouseDown**: 处理下拉菜单的点击选择和关闭
2. **onMouseMove**: 处理下拉菜单的hover高亮
3. **onDrawForeground**: 绘制下拉菜单UI

## 使用场景

### 场景1: 批量添加多个组

```
工作流中有组: "角色A", "角色B", "背景", "特效"

1. 点击 [+ 添加组]
2. 选择 "角色A" → 添加成功
3. 点击 [+ 添加组]
4. 选择 "角色B" → 添加成功
5. 点击 [+ 添加组]
6. 选择 "背景" → 添加成功
```

### 场景2: 更换已添加的组

```
当前列表:
1. 角色A (延迟: 1.0s)
2. 角色B (延迟: 0.5s)

想要将"角色B"换成"特效":
1. 点击"角色B"组名
2. 从下拉菜单选择"特效"
3. 组名立即更新为"特效"（延迟设置保留）
```

### 场景3: 没有可用组的提示

```
如果工作流中还没有创建任何组:
1. 点击 [+ 添加组]
2. 显示提示: "工作流中没有可用的组 / No groups available in workflow"
```

## 优势对比

### 原方式（手动输入）
- ❌ 需要记住组名
- ❌ 容易拼写错误
- ❌ 不知道有哪些组可用
- ❌ 需要手动检查重复

### 新方式（下拉菜单）
- ✅ 自动显示所有可用组
- ✅ 点击选择，不会出错
- ✅ 一目了然所有组
- ✅ 自动防止重复
- ✅ 更快更直观

## 注意事项

1. **组必须已存在**: 下拉菜单只显示工作流中已创建的组
2. **实时更新**: 如果在工作流中添加或删除组，需要重新打开下拉菜单才能看到更新
3. **重复检查**: 尝试添加已存在的组会显示错误提示
4. **延迟设置**: 更换组名时，延迟设置会保留

## 未来改进

可能的增强功能:
- [ ] 支持下拉菜单中直接创建新组
- [ ] 显示组中的节点数量
- [ ] 显示组的颜色标识
- [ ] 搜索/过滤组名
- [ ] 多选添加多个组

## 参考

实现参考了 Fast Groups Muter 的组管理机制：
- 使用 `app.graph._groups` 获取所有组
- Canvas 自定义下拉菜单UI
- 鼠标交互处理
